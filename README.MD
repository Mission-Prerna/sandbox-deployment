#Sandbox Deployment

## Components
There are the below service blocks for the entire NL stack:
1. ODK Central: https://github.com/getodk/central
2. Fusion Auth: https://github.com/fusionauth
3. Backend Service
   1. Postgres
   2. Hasura: https://hasura.io/
   3. PG Bouncer: https://www.pgbouncer.org/
   4. NL APIs: https://github.com/Mission-Prerna/nl-apis
   5. Nginx LB for NL APIs
   6. Redis for NL APIs
   7. UCI Chatbot Helper APIs: https://github.com/Mission-Prerna/uci-chatbot-helper
4. Prometheus Exporters
5. Form Zip Downloader: https://github.com/Samagra-Development/nginx-static-assets
6. Forms Transformer: https://github.com/Samagra-Development/quml2xform
7. User Service: https://github.com/Samagra-Development/user-service
8. Gatekeeper: https://github.com/Samagra-Development/gatekeeper

## Deployment
We are using Docker Compose to deploy the services. The script [`deploy.sh`](./deploy.sh) can be used 
to deploy all the services listed above using an automated process.

The above setup & deployment script has been tested to deploy services on:
- OS: Ubuntu 22
- Docker version 24.0.5, build ced0996
- Docker Compose version v2.20.2

Once you execute command `./deploy.sh`, it'll ask you credentials or variables to setup and configure
the environment config files of each module/service. We have automated the script to use some default (autogenerated) 
values (e.g. for passwords) and you can use them as it is; while the other fields are mandatory and you are expected
to pass them on the command line as asked for.

>Note: You can always override the values later in the respective service directories if needs be.

## Hosting
All the services should ideally be hosted on respective DNS with https to enhance security.
We recommend deploying the services using docker-compose & then use Nginx web server doing reverse
proxying to the respective services. You can also setup HTTPs using certbot to setup lets encrypt free
SSL certificates.

You can use the below sample Nginx template to do the reverse proxy:
```
server {
    etag off;
    server_tokens off;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Content-Type-Options "nosniff";

    server_name sandbox.example.com;
    location / {
        proxy_pass http://localhost:8000;
    }

    listen 80;
}
```